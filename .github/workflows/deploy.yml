name: ğŸš€ Auto Deploy to Hostinger VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 31.97.39.234
          username: mehr-infos-jetzt-app
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: 22
          script_stop: false
          script: |
            set -e
            
            echo "========================================="
            echo "ğŸš€ DEPLOYMENT GESTARTET"
            echo "========================================="
            echo ""
            
            # Zum Projekt-Verzeichnis
            echo "ğŸ“‚ Wechsle zum Projekt-Verzeichnis..."
            cd /home/mehr-infos-jetzt-app/htdocs/app.mehr-infos-jetzt.de || exit 1
            echo "âœ… Bin in: $(pwd)"
            echo ""
            
            # Git Status
            echo "ğŸ“Š Git Status vor Update:"
            git status || true
            echo ""
            
            # Stash lokale Ã„nderungen (falls vorhanden)
            echo "ğŸ’¾ Sichere lokale Ã„nderungen..."
            git stash || true
            echo ""
            
            # Fetch neueste Ã„nderungen
            echo "â¬‡ï¸  Hole neueste Ã„nderungen..."
            git fetch origin main || exit 1
            echo ""
            
            # Reset auf origin/main
            echo "ğŸ”„ Aktualisiere Code..."
            git reset --hard origin/main || exit 1
            echo ""
            
            # Verzeichnisse erstellen
            echo "ğŸ“ Erstelle Verzeichnisse..."
            mkdir -p customer/sections
            mkdir -p admin/sections
            mkdir -p uploads
            mkdir -p logs
            echo "âœ… Verzeichnisse erstellt"
            echo ""
            
            # Berechtigungen
            echo "ğŸ” Setze Berechtigungen..."
            chmod -R 755 customer/ || true
            chmod -R 755 admin/ || true
            chmod -R 755 config/ || true
            chmod -R 755 includes/ || true
            chmod -R 777 uploads/ || true
            chmod -R 777 logs/ || true
            echo "âœ… Berechtigungen gesetzt"
            echo ""
            
            # PrÃ¼fe wichtige Dateien
            echo "ğŸ” PrÃ¼fe Dateien..."
            if [ -f "customer/dashboard.php" ]; then
              echo "âœ… customer/dashboard.php vorhanden"
            else
              echo "âŒ customer/dashboard.php FEHLT!"
            fi
            
            if [ -f "customer/sections/einstellungen.php" ]; then
              echo "âœ… customer/sections/einstellungen.php vorhanden"
            else
              echo "âŒ customer/sections/einstellungen.php FEHLT!"
            fi
            
            if [ -f "customer/sections/kurse.php" ]; then
              echo "âœ… customer/sections/kurse.php vorhanden"
            else
              echo "âŒ customer/sections/kurse.php FEHLT!"
            fi
            
            if [ -f "customer/sections/fortschritt.php" ]; then
              echo "âœ… customer/sections/fortschritt.php vorhanden"
            else
              echo "âŒ customer/sections/fortschritt.php FEHLT!"
            fi
            
            if [ -f "customer/sections/freebies.php" ]; then
              echo "âœ… customer/sections/freebies.php vorhanden"
            else
              echo "âŒ customer/sections/freebies.php FEHLT!"
            fi
            echo ""
            
            # Liste Dateien
            echo "ğŸ“‚ Dateien in customer/sections/:"
            ls -lah customer/sections/ || echo "Verzeichnis nicht gefunden!"
            echo ""
            
            # Letzter Commit
            echo "ğŸ“ Aktueller Commit:"
            git log -1 --oneline
            echo ""
            
            echo "========================================="
            echo "âœ… DEPLOYMENT ERFOLGREICH ABGESCHLOSSEN"
            echo "========================================="
