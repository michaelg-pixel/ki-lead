name: Deploy to Hostinger

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 31.97.39.234
          username: mehr-infos-jetzt-app
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          script: |
            echo "======================================="
            echo "ðŸš€ DEPLOYMENT STARTED"
            echo "Time: $(date)"
            echo "======================================="
            
            # Ins Zielverzeichnis wechseln
            cd /home/mehr-infos-jetzt-app/htdocs/app.mehr-infos-jetzt.de || exit 1
            
            echo "ðŸ“‚ Current directory: $(pwd)"
            
            # Git-Konfiguration
            git config --global --add safe.directory /home/mehr-infos-jetzt-app/htdocs/app.mehr-infos-jetzt.de
            
            # Aktueller Status
            echo "ðŸ“Š Current commit:"
            git log -1 --oneline
            
            # Vom Remote holen
            echo "â¬‡ï¸ Fetching from origin..."
            git fetch origin
            
            # Auf neuesten Stand bringen
            echo "ðŸ”„ Resetting to origin/main..."
            git reset --hard origin/main
            
            # Neuer Status
            echo "âœ… New commit:"
            git log -1 --oneline
            
            # Verzeichnisse erstellen (falls nÃ¶tig)
            mkdir -p customer/sections admin/sections
            
            # Permissions setzen (OHNE .git zu Ã¤ndern!)
            echo "ðŸ”’ Setting permissions (excluding .git)..."
            find . -path ./.git -prune -o -type f -exec chmod 644 {} \;
            find . -path ./.git -prune -o -type d -exec chmod 755 {} \;
            
            # PHP Cache lÃ¶schen
            echo "ðŸ§¹ Clearing PHP cache..."
            php -r "if(function_exists('opcache_reset')) { opcache_reset(); echo 'Cache cleared'; }" 2>/dev/null || echo "OPcache not available"
            
            # Deployment-Timestamp
            echo "Last deployment: $(date)" > .last_deploy
            
            echo "======================================="
            echo "âœ… DEPLOYMENT COMPLETED"
            echo "======================================="