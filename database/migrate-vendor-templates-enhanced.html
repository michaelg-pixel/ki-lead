<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Template Enhancement Migration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .content {
            padding: 2rem;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #1976d2;
            margin-bottom: 0.5rem;
        }

        .info-box ul {
            margin-left: 1.5rem;
            color: #424242;
        }

        .info-box ul li {
            margin: 0.25rem 0;
        }

        .migrate-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .migrate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .migrate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-box {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            display: none;
        }

        .result-box.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
            display: block;
        }

        .result-box.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
            display: block;
        }

        .step {
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f5f5f5;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step.processing {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        .step.success {
            background: #d4edda;
            border-left: 3px solid #28a745;
        }

        .step.error {
            background: #f8d7da;
            border-left: 3px solid #dc3545;
        }

        .step-icon {
            font-size: 1.2rem;
        }

        pre {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üé®</span>
                <span>Vendor Template Enhancement Migration</span>
            </h1>
            <p>Erweitert Vendor Templates mit Mockups, Videokurs-Infos und mehr</p>
        </div>

        <div class="content">
            <div class="info-box">
                <h3>üìã Diese Migration f√ºgt hinzu:</h3>
                <ul>
                    <li><strong>marketplace_price</strong> - Preis f√ºr Marketplace (fehlt aktuell)</li>
                    <li><strong>product_mockup_url</strong> - Mockup-Bild vom Belohnungsprodukt</li>
                    <li><strong>course_duration</strong> - Dauer des Videokurses (z.B. "3 Stunden")</li>
                    <li><strong>original_product_link</strong> - Link zum Original-Produkt</li>
                </ul>
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Hinweis:</strong> Diese Migration erweitert die bestehende vendor_reward_templates Tabelle.
                Stelle sicher, dass du ein Backup deiner Datenbank hast!
            </div>

            <button class="migrate-btn" id="migrateBtn" onclick="startMigration()">
                <span id="btnText">üöÄ Migration starten</span>
                <div class="spinner" id="spinner"></div>
            </button>

            <div id="steps"></div>
            <div class="result-box" id="resultBox"></div>
        </div>
    </div>

    <script>
        async function startMigration() {
            const btn = document.getElementById('migrateBtn');
            const spinner = document.getElementById('spinner');
            const btnText = document.getElementById('btnText');
            const stepsContainer = document.getElementById('steps');
            const resultBox = document.getElementById('resultBox');

            // Disable button
            btn.disabled = true;
            spinner.style.display = 'block';
            btnText.textContent = 'Migration l√§uft...';
            stepsContainer.innerHTML = '';
            resultBox.style.display = 'none';

            const steps = [
                {
                    name: 'marketplace_price Spalte pr√ºfen/hinzuf√ºgen',
                    sql: `ALTER TABLE vendor_reward_templates 
                          ADD COLUMN IF NOT EXISTS marketplace_price DECIMAL(10,2) DEFAULT 0.00 
                          AFTER suggested_referrals_required`
                },
                {
                    name: 'product_mockup_url Spalte hinzuf√ºgen',
                    sql: `ALTER TABLE vendor_reward_templates 
                          ADD COLUMN IF NOT EXISTS product_mockup_url VARCHAR(500) NULL 
                          AFTER preview_image`
                },
                {
                    name: 'course_duration Spalte hinzuf√ºgen',
                    sql: `ALTER TABLE vendor_reward_templates 
                          ADD COLUMN IF NOT EXISTS course_duration VARCHAR(100) NULL 
                          AFTER reward_instructions`
                },
                {
                    name: 'original_product_link Spalte hinzuf√ºgen',
                    sql: `ALTER TABLE vendor_reward_templates 
                          ADD COLUMN IF NOT EXISTS original_product_link VARCHAR(500) NULL 
                          AFTER course_duration`
                }
            ];

            let allSuccess = true;

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                const stepDiv = addStep(step.name, 'processing');

                try {
                    const response = await fetch('/database/execute-sql.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sql: step.sql,
                            description: step.name
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        updateStep(stepDiv, 'success', data.message || 'Erfolgreich');
                    } else {
                        updateStep(stepDiv, 'error', data.error || 'Fehler aufgetreten');
                        allSuccess = false;
                    }
                } catch (error) {
                    updateStep(stepDiv, 'error', error.message);
                    allSuccess = false;
                }

                // Kurze Pause zwischen Steps
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            // Re-enable button
            btn.disabled = false;
            spinner.style.display = 'none';
            btnText.textContent = 'üöÄ Migration starten';

            // Show result
            if (allSuccess) {
                showResult('success', `
                    <h3>‚úÖ Migration erfolgreich abgeschlossen!</h3>
                    <p>Alle Spalten wurden erfolgreich hinzugef√ºgt:</p>
                    <ul>
                        <li>marketplace_price (Preis f√ºr Marketplace)</li>
                        <li>product_mockup_url (Mockup-Upload)</li>
                        <li>course_duration (Videokurs-Dauer)</li>
                        <li>original_product_link (Link zum Original)</li>
                    </ul>
                    <p><strong>N√§chste Schritte:</strong></p>
                    <ol>
                        <li>Update das Template-Formular mit den neuen Feldern</li>
                        <li>Implementiere Mockup-Upload-Funktion</li>
                        <li>Teste die Import-Funktion als Kunde/Vendor</li>
                    </ol>
                `);
            } else {
                showResult('error', `
                    <h3>‚ùå Migration teilweise fehlgeschlagen</h3>
                    <p>Einige Schritte konnten nicht ausgef√ºhrt werden. Pr√ºfe die Details oben und versuche es erneut.</p>
                `);
            }
        }

        function addStep(name, status) {
            const stepsContainer = document.getElementById('steps');
            const stepDiv = document.createElement('div');
            stepDiv.className = `step ${status}`;
            stepDiv.innerHTML = `
                <span class="step-icon" id="icon-${Date.now()}">‚è≥</span>
                <span>${name}</span>
            `;
            stepsContainer.appendChild(stepDiv);
            return stepDiv;
        }

        function updateStep(stepDiv, status, message) {
            stepDiv.className = `step ${status}`;
            const icon = stepDiv.querySelector('.step-icon');
            
            if (status === 'success') {
                icon.textContent = '‚úÖ';
                if (message) {
                    const messageSpan = document.createElement('span');
                    messageSpan.style.color = '#666';
                    messageSpan.style.fontSize = '0.85rem';
                    messageSpan.style.marginLeft = 'auto';
                    messageSpan.textContent = message;
                    stepDiv.appendChild(messageSpan);
                }
            } else if (status === 'error') {
                icon.textContent = '‚ùå';
                if (message) {
                    const messageSpan = document.createElement('span');
                    messageSpan.style.color = '#dc3545';
                    messageSpan.style.fontSize = '0.85rem';
                    messageSpan.style.marginLeft = 'auto';
                    messageSpan.textContent = message;
                    stepDiv.appendChild(messageSpan);
                }
            }
        }

        function showResult(type, html) {
            const resultBox = document.getElementById('resultBox');
            resultBox.className = `result-box ${type}`;
            resultBox.innerHTML = html;
            resultBox.style.display = 'block';
        }
    </script>
</body>
</html>